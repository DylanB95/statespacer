<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>State Space models applied to the UK Road Deaths dataset • statespacer</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="State Space models applied to the UK Road Deaths dataset">
<meta property="og:description" content="A lot of time series exhibit some form of seasonality. In this vignette you  will learn how to deal with seasonality using the statespacer package.  Moreover, you will learn how to add explanatory variables to the State Space  model, and how to estimate multivariate models if there is more than one  dependent variable available.
">
<meta property="og:image" content="https://dylanb95.github.io/statespacer/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">statespacer</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dictionary.html">Dictionary of statespacer</a>
    </li>
    <li>
      <a href="../articles/intro.html">Introduction to statespacer</a>
    </li>
    <li>
      <a href="../articles/seatbelt.html">State Space models applied to the UK Road Deaths dataset</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DylanB95/statespacer/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="seatbelt_files/header-attrs-2.1/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>State Space models applied to the UK Road Deaths dataset</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/DylanB95/statespacer/blob/master/vignettes/seatbelt.Rmd"><code>vignettes/seatbelt.Rmd</code></a></small>
      <div class="hidden name"><code>seatbelt.Rmd</code></div>

    </div>

    
    
<p>A lot of time series exhibit some form of seasonality. An example of such a time serie is the UK Road Deaths dataset, see <code><a href="https://rdrr.io/r/datasets/UKDriverDeaths.html">?Seatbelts</a></code> for details about this dataset. In this vignette you will learn how to deal with this seasonality using the statespacer package. Moreover, you will learn how to add explanatory variables to the State Space model, and how to estimate multivariate models if there is more than one dependent variable available. The UK Road Deaths dataset provides to be an excellent dataset at hand to showcase all of these functionalities of the statespacer package! The approach used in this document follows that of <span class="citation">Commandeur and Koopman (2007)</span>.</p>
<div id="data-preparation" class="section level2">
<h2 class="hasAnchor">
<a href="#data-preparation" class="anchor"></a>Data preparation</h2>
<p>To start, we need to load the package and the dataset. We also log-transform the dependent variables, and some of the explanatory variables.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co"># Load statespacer</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">statespacer</span>)
<span class="co">#&gt; Welcome to the statespacer package!</span>

<span class="co"># Load the dataset</span>
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">datasets</span>)
<span class="no">Data</span> <span class="kw">&lt;-</span> <span class="no">Seatbelts</span>

<span class="co"># Data preparation</span>
<span class="no">Data</span> <span class="kw">&lt;-</span> <span class="no">Seatbelts</span>

<span class="co"># The log of "drivers", "front", and "rear" will be used as dependent variables</span>
<span class="co"># The log of "PetrolPrice" and "kms" will be used as explanatory variables</span>
<span class="no">Data</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"drivers"</span>, <span class="st">"front"</span>, <span class="st">"rear"</span>, <span class="st">"PetrolPrice"</span>, <span class="st">"kms"</span>)] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">Data</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"drivers"</span>, <span class="st">"front"</span>, <span class="st">"rear"</span>, <span class="st">"PetrolPrice"</span>, <span class="st">"kms"</span>)])</pre></body></html></div>
</div>
<div id="univariate-model-with-deterministic-level-and-seasonal" class="section level2">
<h2 class="hasAnchor">
<a href="#univariate-model-with-deterministic-level-and-seasonal" class="anchor"></a>Univariate model with deterministic level and seasonal</h2>
<p>We start off with estimating a univariate model for the “drivers” variable. We specify a deterministic seasonal component of period 12, and a deterministic level. Furhermore, we take the log of “PetrolPrice” together with the “law” dummy as explanatory variables.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co"># Dependent variable</span>
<span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">Data</span>[, <span class="st">"drivers"</span>])

<span class="co"># Period of the seasonal component</span>
<span class="no">BSM_vec</span> <span class="kw">&lt;-</span> <span class="fl">12</span>

<span class="co"># Explanatory variables</span>
<span class="co"># Note: Must be a list of matrices! </span>
<span class="co">#       Each dependent gets its own matrix of explanatory variables.</span>
<span class="no">addvar_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">Data</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"PetrolPrice"</span>, <span class="st">"law"</span>)]))

<span class="co"># Format of the variance - covariance matrix of the level component</span>
<span class="co"># By setting the elements of this matrix to 0, </span>
<span class="co"># the component becomes deterministic.</span>
<span class="no">format_level</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>)

<span class="co"># Format of the variance - covariance matrix of the seasonal component</span>
<span class="co"># Note: This format must be a list of matrices, because multiple </span>
<span class="co">#       seasonalities can be specified!</span>
<span class="no">format_BSM_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>))

<span class="co"># Fitting the model</span>
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/StateSpaceFit.html">StateSpaceFit</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>,
                     <span class="kw">local_level_ind</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                     <span class="kw">BSM_vec</span> <span class="kw">=</span> <span class="no">BSM_vec</span>,
                     <span class="kw">addvar_list</span> <span class="kw">=</span> <span class="no">addvar_list</span>,
                     <span class="kw">format_level</span> <span class="kw">=</span> <span class="no">format_level</span>,
                     <span class="kw">format_BSM_list</span> <span class="kw">=</span> <span class="no">format_BSM_list</span>,
                     <span class="kw">method</span> <span class="kw">=</span> <span class="st">"BFGS"</span>,
                     <span class="kw">initial</span> <span class="kw">=</span> <span class="fl">0.5</span> * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span>(<span class="no">y</span>)))
<span class="co">#&gt; Starting the optimisation procedure at: 2020-04-27 14:43:27</span>
<span class="co">#&gt; Parameter scaling:[1] 1</span>
<span class="co">#&gt; initial  value -0.443442 </span>
<span class="co">#&gt; final  value -0.735372 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; Finished the optimisation procedure at: 2020-04-27 14:43:27</span>
<span class="co">#&gt; Time difference of 0.36663293838501 secs</span>
<span class="co">#&gt; Warning in sqrt(diag(as.matrix(Nmat[, , t + 1]))): NaNs produced</span>

<span class="co">#&gt; Warning in sqrt(diag(as.matrix(Nmat[, , t + 1]))): NaNs produced</span></pre></body></html></div>
<p>The warning can be ignored, it’s a common warning that arises when calculating the square root of a variance that equals a small negative number, like -1e-13. Let’s check out the estimates:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co"># The estimated variance of the observation disturbance</span>
<span class="no">fit</span>$<span class="no">system_matrices</span>$<span class="no">H</span>$<span class="no">H</span>
<span class="co">#&gt;             [,1]</span>
<span class="co">#&gt; [1,] 0.007402015</span>

<span class="co"># Smoothed estimate of the level</span>
<span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">level</span>[<span class="fl">1</span>,]
<span class="co">#&gt; [1] 6.401571</span>

<span class="co"># Smoothed estimate of the coefficient of log "PetrolPrice"</span>
<span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">addvar_coeff</span>[<span class="fl">1</span>, <span class="fl">1</span>]
<span class="co">#&gt; [1] -0.4521301</span>

<span class="co"># Smoothed estimate of the coefficient of the "law" dummy</span>
<span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">addvar_coeff</span>[<span class="fl">1</span>, <span class="fl">2</span>]
<span class="co">#&gt; [1] -0.1971395</span>

<span class="co"># Plot the data next to the smoothed level + explanatory variables components</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">Data</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"drivers"</span>)], <span class="kw">type</span> <span class="kw">=</span> <span class="st">"l"</span>, <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">6.95</span>, <span class="fl">8.1</span>),
     <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"year"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"logarithm of drivers"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">1</span>], <span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">2</span>], <span class="fl">1</span>/<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">3</span>]),
      <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">level</span> + <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">addvar</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">'l'</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="fl">1978</span>, <span class="fl">8.09</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"log(drivers)"</span>, <span class="st">"level + regression effects"</span>),
       <span class="kw">lty</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">1</span>), <span class="kw">lwd</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.5</span>, <span class="fl">2.5</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"black"</span>, <span class="st">"red"</span>))</pre></body></html></div>
<p><img src="seatbelt_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
</div>
<div id="univariate-model-with-stochastic-level-and-seasonal" class="section level2">
<h2 class="hasAnchor">
<a href="#univariate-model-with-stochastic-level-and-seasonal" class="anchor"></a>Univariate model with stochastic level and seasonal</h2>
<p>Now, let’s specify a stochastic level and seasonal component. This can be done by setting the entries in the format of the components to 1.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># By setting the entries in the format to 1, the component becomes stochastic</span>
<span class="no">format_level</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">1</span>)
<span class="no">format_BSM_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">1</span>))
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/StateSpaceFit.html">StateSpaceFit</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>,
                     <span class="kw">local_level_ind</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                     <span class="kw">BSM_vec</span> <span class="kw">=</span> <span class="no">BSM_vec</span>,
                     <span class="kw">addvar_list</span> <span class="kw">=</span> <span class="no">addvar_list</span>,
                     <span class="kw">format_level</span> <span class="kw">=</span> <span class="no">format_level</span>,
                     <span class="kw">format_BSM_list</span> <span class="kw">=</span> <span class="no">format_BSM_list</span>,
                     <span class="kw">method</span> <span class="kw">=</span> <span class="st">"BFGS"</span>,
                     <span class="kw">initial</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span>(<span class="no">y</span>)))
<span class="co">#&gt; Starting the optimisation procedure at: 2020-04-27 14:43:28</span>
<span class="co">#&gt; Parameter scaling:[1] 1 1 1</span>
<span class="co">#&gt; initial  value -0.172423 </span>
<span class="co">#&gt; iter  10 value -0.893962</span>
<span class="co">#&gt; iter  20 value -0.915493</span>
<span class="co">#&gt; iter  30 value -0.915515</span>
<span class="co">#&gt; final  value -0.915517 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; Finished the optimisation procedure at: 2020-04-27 14:43:35</span>
<span class="co">#&gt; Time difference of 6.68783903121948 secs</span>

<span class="co"># The estimated variance of the observation disturbance</span>
<span class="no">fit</span>$<span class="no">system_matrices</span>$<span class="no">H</span>$<span class="no">H</span>
<span class="co">#&gt;            [,1]</span>
<span class="co">#&gt; [1,] 0.00378617</span>

<span class="co"># The estimated variance of the level disturbance</span>
<span class="no">fit</span>$<span class="no">system_matrices</span>$<span class="no">Q</span>$<span class="no">level</span>
<span class="co">#&gt;              [,1]</span>
<span class="co">#&gt; [1,] 0.0002676916</span>

<span class="co"># The estimated variance of the seasonal disturbance</span>
<span class="no">fit</span>$<span class="no">system_matrices</span>$<span class="no">Q</span>$<span class="no">BSM12</span>
<span class="co">#&gt;              [,1]</span>
<span class="co">#&gt; [1,] 1.161414e-06</span>

<span class="co"># Smoothed estimate of the coefficient of log "PetrolPrice"</span>
<span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">addvar_coeff</span>[<span class="fl">1</span>, <span class="fl">1</span>]
<span class="co">#&gt; [1] -0.2913938</span>

<span class="co"># Smoothed estimate of the coefficient of the "law" dummy</span>
<span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">addvar_coeff</span>[<span class="fl">1</span>, <span class="fl">2</span>]
<span class="co">#&gt; [1] -0.2377375</span>

<span class="co"># Plot the data next to the smoothed level + explanatory variables components</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">Data</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"drivers"</span>)], <span class="kw">type</span> <span class="kw">=</span> <span class="st">"l"</span>, <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">6.95</span>, <span class="fl">8.1</span>),
     <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"year"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"logarithm of drivers"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">1</span>], <span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">2</span>], <span class="fl">1</span>/<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">3</span>]),
      <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">level</span> + <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">addvar</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">'l'</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span>(<span class="fl">1978</span>, <span class="fl">8.09</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"log(drivers)"</span>, <span class="st">"level + regression effects"</span>),
       <span class="kw">lty</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">1</span>), <span class="kw">lwd</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2.5</span>, <span class="fl">2.5</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"black"</span>, <span class="st">"red"</span>))</pre></body></html></div>
<p><img src="seatbelt_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>Plotting the stochastic seasonal, we can see that it barely changes over time, which is in line with the near zero value of its variance. It might be worthwhile to set the seasonal component to be deterministic, while letting the level be stochastic. I’ll leave that as an exercise for you. You can compare the AICs of both models, and see which one scores better!</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># Plot the stochastic seasonal and irregular as well</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">1</span>], <span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">2</span>], <span class="fl">1</span>/<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">3</span>]),
     <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">BSM12</span>,
     <span class="kw">type</span> <span class="kw">=</span> <span class="st">"l"</span>, <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">0.2</span>, <span class="fl">0.3</span>),
     <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"year"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"stochastic seasonal"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="fl">0</span>)</pre></body></html></div>
<p><img src="seatbelt_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<p>And for the sake of completeness, the irregular component:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">1</span>], <span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">2</span>], <span class="fl">1</span>/<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">3</span>]),
     <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">epsilon</span>,
     <span class="kw">type</span> <span class="kw">=</span> <span class="st">"l"</span>, <span class="kw">ylim</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">0.15</span>, <span class="fl">0.15</span>),
     <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"year"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"irregular component"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="fl">0</span>)</pre></body></html></div>
<p><img src="seatbelt_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</div>
<div id="bivariate-model-of-front-and-rear-passengers" class="section level2">
<h2 class="hasAnchor">
<a href="#bivariate-model-of-front-and-rear-passengers" class="anchor"></a>Bivariate model of front and rear passengers</h2>
<p>The previous models dealed with a univariate serie. However, it might be interesting to model multiple series simultaneously. In this section we’ll just do that. We’ll take the logs of “front” and “rear” as dependent variables, the “law” dummy together with the logs of “PetrolPrice” and “kms” as explanatory variables, a stochastic local level component, and a deterministic seasonal component with period 12.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># Dependent variable</span>
<span class="no">y</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">Data</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"front"</span>, <span class="st">"rear"</span>)])

<span class="co"># Explanatory variables</span>
<span class="co"># Note: Must be a list of matrices! </span>
<span class="co">#       Each dependent gets its own matrix of explanatory variables.</span>
<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">Data</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"PetrolPrice"</span>, <span class="st">"kms"</span>, <span class="st">"law"</span>)])
<span class="no">addvar_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">X</span>, <span class="no">X</span>)

<span class="co"># Format of the variance - covariance matrix of the level component</span>
<span class="co"># Note: Only the lower triangular part of the format is used.</span>
<span class="co">#       The format specifies which elements in the matrices L and D should be </span>
<span class="co">#       non-zero, where L and D are the matrices of the Cholesky LDL decomposition.</span>
<span class="co">#       The diagonal is used to specify which elements of the Diagonal matrix</span>
<span class="co">#       should be non-zero. The lower triangular part excluding the diagonal </span>
<span class="co">#       specifies which elements in the Loading matrix should be non-zero.</span>
<span class="no">format_level</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>)

<span class="co"># Format of the variance - covariance matrix of the seasonal component</span>
<span class="co"># Note: This format must be a list of matrices, because multiple seasonalities</span>
<span class="co">#       can be specified!</span>
<span class="no">format_BSM_list</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span>))

<span class="co"># Format of the variance - covariance matrix of the observation disturbances</span>
<span class="no">H_format</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>)

<span class="co"># Fitting the model</span>
<span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/StateSpaceFit.html">StateSpaceFit</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>,
                     <span class="kw">H_format</span> <span class="kw">=</span> <span class="no">H_format</span>,
                     <span class="kw">local_level_ind</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                     <span class="kw">BSM_vec</span> <span class="kw">=</span> <span class="fl">12</span>,
                     <span class="kw">addvar_list</span> <span class="kw">=</span> <span class="no">addvar_list</span>,
                     <span class="kw">format_level</span> <span class="kw">=</span> <span class="no">format_level</span>,
                     <span class="kw">format_BSM_list</span> <span class="kw">=</span> <span class="no">format_BSM_list</span>,
                     <span class="kw">method</span> <span class="kw">=</span> <span class="st">"BFGS"</span>,
                     <span class="kw">initial</span> <span class="kw">=</span> <span class="fl">0.5</span> * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/cor.html">var</a></span>(<span class="no">y</span>))))
<span class="co">#&gt; Starting the optimisation procedure at: 2020-04-27 14:43:37</span>
<span class="co">#&gt; Parameter scaling:[1] 1 1 1 1 1 1</span>
<span class="co">#&gt; initial  value 0.389588 </span>
<span class="co">#&gt; iter  10 value -1.583528</span>
<span class="co">#&gt; iter  20 value -1.676129</span>
<span class="co">#&gt; iter  30 value -1.676530</span>
<span class="co">#&gt; final  value -1.676537 </span>
<span class="co">#&gt; converged</span>
<span class="co">#&gt; Finished the optimisation procedure at: 2020-04-27 14:44:23</span>
<span class="co">#&gt; Time difference of 45.8162000179291 secs</span></pre></body></html></div>
<p>Checking out the estimates and plotting the levels:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># The estimated variance - covariance matrix of the observation disturbance</span>
<span class="no">fit</span>$<span class="no">system_matrices</span>$<span class="no">H</span>$<span class="no">H</span>
<span class="co">#&gt;             [,1]        [,2]</span>
<span class="co">#&gt; [1,] 0.005402172 0.004449537</span>
<span class="co">#&gt; [2,] 0.004449537 0.008566860</span>

<span class="co"># The estimated variance - covariance matrix of the level disturbance</span>
<span class="no">fit</span>$<span class="no">system_matrices</span>$<span class="no">Q</span>$<span class="no">level</span>
<span class="co">#&gt;              [,1]         [,2]</span>
<span class="co">#&gt; [1,] 0.0002556382 0.0002247037</span>
<span class="co">#&gt; [2,] 0.0002247037 0.0002319563</span>

<span class="co"># Coefficients + T-stats</span>
<span class="no">coeff</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"front PetrolPrice"</span>, <span class="st">"front kms"</span>, <span class="st">"front law"</span>,
    <span class="st">"rear PetrolPrice"</span>, <span class="st">"rear kms"</span>, <span class="st">"rear law"</span>),
  <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">addvar_coeff</span>[<span class="fl">1</span>,],
  <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">addvar_coeff</span>[<span class="fl">1</span>,] / <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">addvar_coeff_se</span>[<span class="fl">1</span>,]
)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">coeff</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Variable"</span>, <span class="st">"Coefficient"</span>, <span class="st">"T-Stat"</span>)
<span class="no">coeff</span>
<span class="co">#&gt;      Variable            Coefficient            T-Stat              </span>
<span class="co">#&gt; [1,] "front PetrolPrice" "-0.307614976368415"   "-2.8986113778144"  </span>
<span class="co">#&gt; [2,] "front kms"         "0.151804327080036"    "1.16776361125407"  </span>
<span class="co">#&gt; [3,] "front law"         "-0.337045865872819"   "-6.84659512458969" </span>
<span class="co">#&gt; [4,] "rear PetrolPrice"  "-0.0857576087847562"  "-0.764053664481983"</span>
<span class="co">#&gt; [5,] "rear kms"          "0.550390286928824"    "3.79270161272422"  </span>
<span class="co">#&gt; [6,] "rear law"          "0.000887620255411288" "0.017133129436154"</span>

<span class="co"># plot of level for "front"</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">1</span>], <span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">2</span>], <span class="fl">1</span>/<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">3</span>]),
     <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">level</span>[, <span class="fl">1</span>], <span class="kw">type</span> <span class="kw">=</span> <span class="st">"l"</span>,
     <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"year"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"level of front passengers"</span>)</pre></body></html></div>
<p><img src="seatbelt_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<div class="sourceCode" id="cb9"><html><body><pre class="r">
<span class="co"># plot of level for "rear"</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">1</span>], <span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">2</span>], <span class="fl">1</span>/<span class="fu"><a href="https://rdrr.io/r/stats/tsp.html">tsp</a></span>(<span class="no">Data</span>)[<span class="fl">3</span>]),
     <span class="no">fit</span>$<span class="no">smoothed</span>$<span class="no">level</span>[, <span class="fl">2</span>], <span class="kw">type</span> <span class="kw">=</span> <span class="st">"l"</span>,
     <span class="kw">xlab</span> <span class="kw">=</span> <span class="st">"year"</span>, <span class="kw">ylab</span> <span class="kw">=</span> <span class="st">"level of rear passengers"</span>)</pre></body></html></div>
<p><img src="seatbelt_files/figure-html/unnamed-chunk-8-2.png" width="672"></p>
<p>We see that the levels closely resemble each other. In fact, their correlation is almost equal to 1:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">fit</span>$<span class="no">system_matrices</span>$<span class="no">Q_correlation_matrix</span>$<span class="no">level</span>
<span class="co">#&gt;           [,1]      [,2]</span>
<span class="co">#&gt; [1,] 1.0000000 0.9227716</span>
<span class="co">#&gt; [2,] 0.9227716 1.0000000</span></pre></body></html></div>
<p>It is possible to restrict the rank of the variance - covariance matrix of the level component to be 1. This can be done by setting <code>format_level</code> as follows:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">format_level</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">2</span>)
<span class="no">format_level</span>[, <span class="fl">1</span>] <span class="kw">&lt;-</span> <span class="fl">1</span></pre></body></html></div>
<p>Feel free to estimate the model with this new specification yourself! I’d also suggest dropping the “law” dummy for the “rear” passengers, but keeping it in for the “front” passengers.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references hanging-indent">
<div id="ref-commandeur2007introduction">
<p>Commandeur, Jacques JF, and Siem Jan Koopman. 2007. <em>An Introduction to State Space Time Series Analysis</em>. Oxford University Press.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Dylan Beijers.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
